# Metrics

## Getting Started

```{r include=FALSE}
source(here::here("project_settings.R"), echo=TRUE)
```

### Metrics


If this function is applied, a bird would have the following metrics for every DAY the device was deployed:

* **Total proportion of time wet per day:** proportion of seconds wet across all 2-hour bins for the day, where (count of wets in each bin * 30 seconds) / 7200 seconds.

* **Total number of state switches (wet/dry transitions) per day:** number of times the device switched between wet (non-zero) and dry (zero) states across all 2-hour bins.

* **Cumulative dry and wet times per day:** total time (in seconds) the device recorded as completely dry (wets == 0) or wet (wets > 0) during the sampling intervals within the day.

* **Longest continuous periods of dry or wet states throughout the whoel deployment period:** longest sequence of consecutive 10-minute intervals within the entire deployment period where the device recorded:

    Fully dry (wets == 0)
    Wet (wets > 0)
    Very wet (wets > 15)
    Completely saturated (wets == 20)

Function to calculate metrics per day
```{r}
calc_daily_metrics <- function(file_path) {
  deg_data <- read_csv(file_path, show_col_types=FALSE)
  
  bird_id <- str_extract(basename(file_path), "(?<=filtered_)[A-Z-0-9]{5}")
  
  #start by calculating metrics for a single 2hr bin
  metrics <- deg_data %>%
    mutate(
      bin_length = 7200, #2hrs in secs
      
      #proportion of time wet in 2hr period (wets*30 converts wetness level into secs spent wet)
      # (600sec per 10min interval) / 20 = 30 seconds per unit 
      prop_wet = (wets * 30) / bin_length, 
      
      #switches between wet (non-zero) and dry (zero) states
      switches= ifelse(row_number() == 1,0,
                       abs(diff(ifelse(wets > 0, 1, 0)))),
      
      #cumulative time spent dry (== 0) or wet (>0)
      dry_time= ifelse(wets == 0, 10*60, 0), # if dry, time always 600 secs
      wet_time = ifelse(wets > 0, 10*60, 0)  # if wet, time always 600 secs
    ) %>%
    
    #summarize the metrics for the full deployment period, grouped by day
    group_by(date) %>%
    summarize(
      bird_id = bird_id,
      total_prop_wet = sum(prop_wet, na.rm = TRUE),
      total_switches = sum(switches, na.rm=TRUE),
      total_dry_time = sum(dry_time, na.rm=TRUE),
      total_wet_time = sum(wet_time, na.rm=TRUE),
      )
  
  return(metrics)
}
```


#### DAILY PERIODS

Function for plotting daily metrics
```{r}

plot_daily_metrics <- function(metrics, metric_name, y_label, title) {
  ggplot(metrics, aes(x=as.Date(date), y=!!sym(metric_name), color = bird_id)) +
    geom_line() + 
    geom_point() + 
    labs(title = title,
         y = y_label,
         x = "Time (days)",
         color = "Bird ID" ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), title = element_text(size=8),
      legend.position = "right",  #this is not wokring
      legend.direction = "vertical",
      legend.box = "vertical",
      legend.spacing.y = (unit(0.2, "cm")),
    scale_x_date(
      breaks = "1 month",
      labels = date_format("%b %Y")
    ))
}
```

Let's start with 5 files for comparison
```{r}
#get list of downsampled files to process 
files <- list.files(downsampled.dir, full.names=TRUE)

example_birds <- files[1:5]
```

```{r}
example_daily_metrics <- future_map_dfr(example_birds, daily_metrics)

example_daily_metrics
```


```{r}
plot_prop <- plot_daily_metrics(example_daily_metrics, "total_prop_wet", 
                          "Proportion of period (day)", 
                          "Total Proportion of Wet Periods per Day")

plot_switch <- plot_daily_metrics(example_daily_metrics, "total_switches", 
                            "Number of switches", 
                            "Total Switches Between Wet-Dry Per Day")

(plot_prop|plot_switch)
```

So for these birds we see a good trend, between Dec 2017 and May 2018 there is a high proportion of wet periods. 
The total number of times the device switches from wet to dry reduces during the periods where there is a lot of wets, seems to make sense.


We can also consider the two hour periods and not fiddle around with summing up every metric by days
this would give us a finer resolution for looking at things like the longest period the device was wet/dry

```{r}
full_metrics <- function(file_path) {
  deg_data <- read_csv(file_path, show_col_types = FALSE)
  deg_data <- deg_data %>%
    mutate(datetime_start = as.POSIXct(paste(date, start_time), format = "%Y-%m-%d %H:%M:%S"))
  bird_id <- str_extract(basename(file_path), "(?<=filtered_)[A-Z-0-9]{5}")
  
  longest_dry = max(rle(deg_data$wets == 0)$lengths) * 10 * 60 # Longest continuous dry time
  longest_wet = max(rle(deg_data$wets > 0)$lengths) * 10 * 60  # Longest continuous wet time
  longest_very_wet = max(rle(deg_data$wets > 15)$lengths) *10 * 60 #max period wet > 15 in 600secs
  longest_entirely_wet = max(rle(deg_data$wets == 20)$lengths) *10 * 60 #max period wet == 20 in 600secs

  return(data.frame(
    bird_id = bird_id,
    longest_dry = longest_dry / 3600, #divide by 3600 to convert into hours
    longest_wet = longest_wet / 3600,
    longest_very_wet = longest_very_wet / 3600,
    longest_entirely_wet = longest_entirely_wet / 3600
    ))
  
}

files <- list.files(downsampled.dir, full.names=TRUE)

example_birds <- files[1:1]

example_full_metrics <- future_map_dfr(example_birds, full_metrics)

```

Lastly, let's look at all of the wet and dry periods throughout the entire deployment time so we can visualise how they change over time an dmaybe see when those really long periods of entirely wet are

```{r}

prepare_plot_data <- function(file_path) {
  deg_data <- read_csv(file_path, show_col_types = FALSE) %>%
      mutate(
      datetime_start = as.POSIXct(paste(date, start_time), format = "%Y-%m-%d %H:%M:%S"),
      bird_id = str_extract(basename(file_path), "(?<=filtered_)[A-Z-0-9]{5}")
    )
  return(deg_data)
}

plot_data <- example_birds %>%
  lapply(prepare_plot_data) %>%
  bind_rows()

plot_all_wet_periods <- ggplot(plot_data, aes(x=datetime_start, y=wets, color=bird_id)) +
  geom_line() +
  labs(
    title = "Dry and Wet Periods Over Entire Deployment Period",
    x= "Time (2hr intervals)",
    y= "Wetness",
    color = "Bird ID") +
  scale_y_continuous(
    breaks = seq(0, 20, 5)) +
  theme_minimal()



```


Okkkk thats fun

ii shoudl look into how takign the average for every two hr period here impacts this 

maybe i shouldnt be binning that way

will look into different ways of handlig wets, maybe just leave at 10mins? but this resolution is already too high 

what im doign now
binning wets by 2 hours, taking average of wets to bin them here

then im considering wets/dries for that entire deployment period (each point = 2hrs)
but im also considering full daily metrics inside of that which probably isnt a great approach - look into binnig daily first instead of by 2hrs with average and then daily.


