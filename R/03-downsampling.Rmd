# Downsampling

## Load settings

```{r include=FALSE}
source(here::here("project_settings.R"), echo=TRUE)
```


## Down-sampling (MEAN wets)

**Katie Notes:**
Right now the files are logging every 10 minutes, which is too high of a resolution. Need to down-sample the dataset from 10min to some other interval that is meaningful to define states to.

12hrs seems too long given how far birds can move in this time, but 10min is far too short.

Tempted to use 2hr resolution to match GPS. 
For example, within each 2hr period we need to assess:

•	Proportion wet or time wet ((Count wets in 2hr period * 30sec) / 72000sec)
•	Number of switches between 0 and non-zero value
•	Total time when entire 10min sampling interval was dry (count 0s * 10min)
•	Total time when entire 10min sampling interval was wet (count >=1 * 10min)
•	Longest continuous time dry (longest number of consecutive rows with wets==0  * 10min)
•	Longest continuous time wet (longest number of consecutive rows with wets>=1 * 10min)

### 2hr Periods

```{r eval=FALSE}

#made a new dir called downsampled in /data
source(here("utils/downsample_deg.R"), echo = F)

bin_time = 2

#define deg files to use
deg_files <- list.files(output.dir, pattern = "*.deg", full.names = TRUE)#[1:10] #add if you want to subset


if (TRUE) {
#set up a furrr plan for using 4 cores
plan(multisession, workers = 4)

deg_2hrs <- future_map(deg_files, downsample_deg, bin_time = bin_time, .progress = TRUE)

plan(sequential)
}

```


This is what the deg files look like now:
```
date,start_time,end_time,wets
2022-09-08,00:00:00,01:59:59,0
2022-09-08,02:00:00,03:59:59,0
2022-09-08,04:00:00,05:59:59,0
2022-09-08,06:00:00,07:59:59,...
```

wets = 0 means 10min interval was entirely wet
wets = 20 means 10min interval was entirely dry

For one 10min interval,
if wets=1, then 600s/20 = 30 seconds
so 1 unit wets = 30 seconds wet per 10min interval

So our dataset's `wets` values now represent the average number of 10-minute intervals that were wet during the 2-hour period. This means each 2hr period has 12 intervals of 10 minutes (600 secs).



### 1hr Periods

```{r eval=FALSE}

#define what deg files to use
deg_files <- list.files(file.path(data.dir, "downsampled_2hr_avg"),
                        pattern = "*.deg", 
                        full.names = TRUE)#[1:5] #add if you want to subset
#set your bin_time
bin_time = 2

if (FALSE) {
#set up a furrr plan for using 4 cores
plan(multisession, workers = 4)

future_map(deg_files, downsample_deg_avg, bin_time = bin_time, .progress = TRUE)

plan(sequential)
}

```

```
date,start_time,end_time,wets
2017-09-20,00:00:00,00:59:59,0
2017-09-20,01:00:00,01:59:59,0
2017-09-20,02:00:00,02:59:59,0
2017-09-20,03:00:00,03:59:59,0
2017-09-20,04:00:00,04:59:59,0
2017-09-20,05:00:00,05:59:59,5.333
2017-09-20,06:00:00,06:59:59,6.333
```


### 5hr Periods

Do it again for 5hr bin
```{r eval=FALSE}

bin_time = 5

if (FALSE) {

plan(multisession, workers = 4)

future_map(deg_files, downsample_deg_avg, bin_time = bin_time, .progress = TRUE)


plan(sequential)
}
```

```
date,start_time,end_time,wets
2017-09-20,00:00:00,04:59:59,0
2017-09-20,05:00:00,09:59:59,4.867
2017-09-20,10:00:00,14:59:59,2.6
2017-09-20,15:00:00,19:59:59,2.733
2017-09-20,20:00:00,00:59:59,5.375
2017-09-21,00:00:00,04:59:59,5.067
2017-09-21,05:00:00,09:59:59,7.567
2017-09-21,10:00:00,14:59:59,2.2
```

## Down-sampling (SUM wets)

Downsample the data taking the sum, files end up in `downsampled_sum_Xhrs`
(I only did this for 2hr bins so far)

### 2hr Periods

```{r eval=FALSE}

#made a new dir called downsampled in /data
source(here("utils/downsample_deg_sum.R"), echo = F)

bin_time = 2

#define deg files to use
deg_files <- list.files(output.dir, pattern = "*.deg", full.names = TRUE)#[1:5] #add if you want to subset


if (FALSE) {
#set up a furrr plan for using 4 cores
plan(multisession, workers = 4)

future_map(deg_files, downsample_deg_sum, bin_time = bin_time, .progress = TRUE)

plan(sequential)
}

```

When we downsampled taking the mean, file BH584 looked like this:
```
date,start_time,end_time,wets
2017-09-20,00:00:00,01:59:59,0
2017-09-20,02:00:00,03:59:59,0
2017-09-20,04:00:00,05:59:59,2.667
2017-09-20,06:00:00,07:59:59,6.5
2017-09-20,08:00:00,09:59:59,3
2017-09-20,10:00:00,11:59:59,1.5
```

This is what the deg files look like now that we summed wets for BH584 instead:
```
date,start_time,end_time,wets
2017-09-20,00:00:00,01:59:59,0
2017-09-20,02:00:00,03:59:59,0
2017-09-20,04:00:00,05:59:59,32
2017-09-20,06:00:00,07:59:59,78
2017-09-20,08:00:00,09:59:59,36
2017-09-20,10:00:00,11:59:59,18
```
